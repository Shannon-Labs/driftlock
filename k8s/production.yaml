# Driftlock Production Deployment
#
# This manifest deploys the complete Driftlock stack with:
# - API server with proper resource limits
# - Service for internal/external access
# - ConfigMap for configuration
# - Secrets for sensitive data
# - Health checks and security settings

---
apiVersion: v1
kind: Namespace
metadata:
  name: driftlock
  labels:
    name: driftlock
    purpose: anomaly-detection

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: driftlock-api
  namespace: driftlock
  labels:
    app: driftlock-api
    version: v1
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: driftlock-api
  template:
    metadata:
      labels:
        app: driftlock-api
    spec:
      serviceAccountName: driftlock-api
      automountServiceAccountToken: false
      containers:
      - name: api
        image: driftlock/api:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: driftlock-secrets
              key: database-url
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: driftlock-secrets
              key: jwt-secret
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: LOG_LEVEL
        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: ENVIRONMENT
        - name: API_READ_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: API_READ_TIMEOUT
        - name: API_WRITE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: API_WRITE_TIMEOUT
        - name: API_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: API_IDLE_TIMEOUT
        - name: DB_MAX_OPEN_CONNS
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: DB_MAX_OPEN_CONNS
        - name: DB_MAX_IDLE_CONNS
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: DB_MAX_IDLE_CONNS
        - name: DB_CONN_MAX_LIFETIME
          valueFrom:
            configMapKeyRef:
              name: driftlock-config
              key: DB_CONN_MAX_LIFETIME
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30  # 30 * 5 = 150 seconds to start up
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 3000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp-volume
          mountPath: /tmp
      volumes:
      - name: tmp-volume
        emptyDir: {}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
      tolerations:
      - key: "node-type"
        operator: "Equal"
        value: "driftlock"
        effect: "NoSchedule"

---
apiVersion: v1
kind: Service
metadata:
  name: driftlock-api
  namespace: driftlock
  labels:
    app: driftlock-api
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
spec:
  selector:
    app: driftlock-api
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      name: http
  type: LoadBalancer

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: driftlock-config
  namespace: driftlock
data:
  LOG_LEVEL: "info"
  ENVIRONMENT: "production"
  API_READ_TIMEOUT: "30s"
  API_WRITE_TIMEOUT: "30s"
  API_IDLE_TIMEOUT: "60s"
  # Database connection settings
  DB_MAX_OPEN_CONNS: "25"
  DB_MAX_IDLE_CONNS: "10"
  DB_CONN_MAX_LIFETIME: "1h"
  # OTel collector settings
  OTEL_COLLECTOR_ENDPOINT: "otel-collector:4317"
  # Feature flags
  ENABLE_SSE_STREAMING: "true"
  ENABLE_EVIDENCE_EXPORT: "true"
  # Rate limiting
  GLOBAL_RATE_LIMIT_RPS: "1000"
  GLOBAL_RATE_LIMIT_BURST: "2000"

---
apiVersion: v1
kind: Secret
metadata:
  name: driftlock-secrets
  namespace: driftlock
type: Opaque
data:
  # These should be base64 encoded values
  # Generate with: echo -n 'your-secret-value' | base64
  database-url: >-
    # TODO: Replace with actual base64 encoded database connection string
    # Example: postgresql://user:password@host:port/database?sslmode=disable
    ZGVtb2RiOnBhc3N3b3JkQGRlbW8tcG9zdGdyZXNxbDo1NDMy # This decodes to: demodb:password@demo-postgres:5432
  jwt-secret: >-
    # TODO: Replace with actual base64 encoded JWT secret (at least 32 chars)
    # Generate with: openssl rand -base64 32 | tr -d '\n' | base64
    dGhpc2lzYXJlYWxseWxvbmdhbmRzZWN1cmVzZWNyZXRmb3Jqd3QK # This decodes to: thisisareallylongandsecuresecretforjwt

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: driftlock-api
  namespace: driftlock
  labels:
    app: driftlock-api

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: driftlock
  name: driftlock-api
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: driftlock-api
  namespace: driftlock
subjects:
- kind: ServiceAccount
  name: driftlock-api
  namespace: driftlock
roleRef:
  kind: Role
  name: driftlock-api
  apiGroup: rbac.authorization.k8s.io