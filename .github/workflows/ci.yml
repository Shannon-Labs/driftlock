name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  rust:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cbad-core
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - name: Build (release)
        run: cargo build --release

  go:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: collector-processor
    env:
      LD_LIBRARY_PATH: ${{ github.workspace }}/cbad-core/target/release:${LD_LIBRARY_PATH}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - name: Build cbad-core (release)
        working-directory: cbad-core
        run: cargo build --release
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Test
        run: go test ./...

  docker:
    runs-on: ubuntu-latest
    needs: [rust, go]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Run Docker build smoke tests
        env:
          ENABLE_OPENZL_BUILD: "false"
        run: ./scripts/test-docker-build.sh

  go-openzl:
    name: Go + OpenZL (optional)
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      LD_LIBRARY_PATH: ${{ github.workspace }}/cbad-core/target/release:${LD_LIBRARY_PATH}
      OPENZL_LIB_DIR: ${{ github.workspace }}/openzl
      CGO_LDFLAGS: -L${{ github.workspace }}/cbad-core/target/release -lcbad_core
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y build-essential pkg-config clang
      - name: Build OpenZL static lib
        run: |
          cd openzl
          CFLAGS="-fPIC ${CFLAGS:-}" CXXFLAGS="-fPIC ${CXXFLAGS:-}" make lib
      - name: Build cbad-core with OpenZL
        working-directory: cbad-core
        run: |
          OPENZL_LIB_DIR="${OPENZL_LIB_DIR}" cargo build --release --features openzl
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Go tests (OpenZL)
        working-directory: collector-processor
        env:
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}
          CGO_LDFLAGS: ${{ env.CGO_LDFLAGS }}
        run: go test ./...
      - name: OpenZL benchmark (optional)
        working-directory: collector-processor
        env:
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}
          CGO_LDFLAGS: ${{ env.CGO_LDFLAGS }}
        run: go test -run TestDoesNotExist -bench OpenZLPreference -count=1 ./cmd/driftlock-http
