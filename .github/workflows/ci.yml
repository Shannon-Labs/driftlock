name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  LD_LIBRARY_PATH: ${{ github.workspace }}/cbad-core/target/release

jobs:
  commitlint:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install commitlint
        run: bun install @commitlint/cli @commitlint/config-conventional

      - name: Validate commits
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: bunx commitlint --from "$BASE_SHA" --to "$HEAD_SHA" --verbose

  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install just
        run: sudo apt-get update && sudo apt-get install -y just

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            functions/package-lock.json
            extensions/vscode-driftlock/package-lock.json

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cbad-core/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('cbad-core/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            functions/node_modules
            extensions/vscode-driftlock/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json', 'functions/package-lock.json', 'extensions/vscode-driftlock/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: just setup

      - name: Build Rust core
        run: just build-core

      - name: Lint
        run: just lint

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.62
          working-directory: collector-processor
          args: --timeout=5m

      - name: Test Go with Coverage
        working-directory: collector-processor
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out | grep total

      - name: Test Rust
        working-directory: cbad-core
        run: cargo test

      - name: Test Frontend
        run: |
          cd landing-page && bun run type-check
          cd ../functions && npm run lint

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: collector-processor/coverage.out
          flags: backend
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  docker:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install just
        run: sudo apt-get update && sudo apt-get install -y just

      - name: Smoke test Docker builds
        env:
          ENABLE_OPENZL_BUILD: "false"
        run: just docker-test

  go-openzl:
    name: Go + OpenZL (optional)
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: lint-and-test
    env:
      LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}
      OPENZL_LIB_DIR: ${{ github.workspace }}/openzl
      CGO_LDFLAGS: -L${{ github.workspace }}/cbad-core/target/release -lcbad_core
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable

      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y build-essential pkg-config clang

      - name: Build OpenZL static lib
        run: |
          cd openzl
          CFLAGS="-fPIC ${CFLAGS:-}" CXXFLAGS="-fPIC ${CXXFLAGS:-}" make lib

      - name: Build cbad-core with OpenZL
        working-directory: cbad-core
        run: |
          OPENZL_LIB_DIR="${OPENZL_LIB_DIR}" cargo build --release --features openzl

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Go tests (OpenZL)
        working-directory: collector-processor
        env:
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}
          CGO_LDFLAGS: ${{ env.CGO_LDFLAGS }}
        run: go test ./...

      - name: OpenZL benchmark (optional)
        working-directory: collector-processor
        env:
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}
          CGO_LDFLAGS: ${{ env.CGO_LDFLAGS }}
        run: go test -run TestDoesNotExist -bench OpenZLPreference -count=1 ./cmd/driftlock-http
