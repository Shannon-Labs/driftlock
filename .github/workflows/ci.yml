name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  rust:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cbad-core
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - name: Build (release)
        run: cargo build --release

  go:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: collector-processor
    env:
      LD_LIBRARY_PATH: ${{ github.workspace }}/cbad-core/target/release:${LD_LIBRARY_PATH}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - name: Build cbad-core (release)
        working-directory: cbad-core
        run: cargo build --release
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Test
        run: go test ./...

  docker:
    runs-on: ubuntu-latest
    needs: [rust, go]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Run Docker build smoke tests
        env:
          ENABLE_OPENZL_BUILD: "false"
        run: ./scripts/test-docker-build.sh
