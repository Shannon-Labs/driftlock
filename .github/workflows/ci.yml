name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.22'
  RUST_TOOLCHAIN: 'stable'
  NODE_VERSION: '18'

jobs:
  test-rust:
    name: Test Rust (CBAD Core)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_TOOLCHAIN }}

    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          cbad-core/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run tests
      working-directory: cbad-core
      run: cargo test --verbose

    - name: Run lints
      working-directory: cbad-core
      run: cargo clippy -- -D warnings

    - name: Check formatting
      working-directory: cbad-core
      run: cargo fmt -- --check

  test-go:
    name: Test Go (API Server)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      working-directory: api-server
      run: go mod download

    - name: Run tests
      working-directory: api-server
      run: go test -v -race -coverprofile=coverage.out ./...

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./api-server/coverage.out
        flags: api-server
        name: api-server-coverage

    - name: Run lints
      uses: golangci/golangci-lint-action@v3
      with:
        working-directory: api-server
        version: latest

  test-node:
    name: Test Node.js (Dashboard)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: web-frontend/package-lock.json

    - name: Install dependencies
      working-directory: web-frontend
      run: npm ci

    - name: Run tests
      working-directory: web-frontend
      run: npm run build

    - name: Run lints
      working-directory: web-frontend
      run: npm run lint

    - name: Type check
      working-directory: web-frontend
      run: npm run type-check || echo "No type-check script, skipping"

    - name: Build
      working-directory: web-frontend
      run: npm run build

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-rust, test-go, test-node]

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: driftlock_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_VERSION }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: Build Rust library
      working-directory: cbad-core
      run: cargo build --release

    - name: Run integration tests
      working-directory: api-server
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/driftlock_test?sslmode=disable
        DEFAULT_API_KEY: test_api_key_integration_tests
      run: |
        go mod download
        go test -v -tags=integration ./...

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-rust, test-go, test-node]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build API Server image
      uses: docker/build-push-action@v5
      with:
        context: src/api-server
        push: false
        tags: driftlock/api-server:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build Dashboard image
      uses: docker/build-push-action@v5
      with:
        context: src/dashboard
        push: false
        tags: driftlock/dashboard:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Run Gosec Security Scanner
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: '-no-fail -fmt sarif -out gosec.sarif ./src/api-server/...'

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: gosec.sarif

    - name: Rust security audit
      uses: actions-rs/audit-check@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
