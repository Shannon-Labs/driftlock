openapi: 3.0.3
info:
  title: Driftlock API
  version: 1.0.0
  description: |
    Compression-based anomaly detection for any JSON event stream.

    ## Quick Start

    1. **Try without signup**: Use `POST /v1/demo/detect` (10 req/min, 50 events max)
    2. **Sign up**: `POST /v1/onboard/signup` → verify email → get API key
    3. **Detect anomalies**: `POST /v1/detect` with `X-Api-Key` header

    ## Authentication

    - **API Key**: Pass `X-Api-Key: dlk_<uuid>.<secret>` header for detection endpoints
    - **Firebase Auth**: Pass `Authorization: Bearer <firebase-id-token>` for dashboard endpoints

    ## Rate Limits

    - Demo endpoint: 10 requests/minute per IP, max 50 events
    - Authenticated: Based on your plan (see /v1/me/usage)
  contact:
    name: Driftlock Support
    email: support@driftlock.net
    url: https://driftlock.net
  license:
    name: Proprietary
    url: https://driftlock.net/terms

servers:
  - url: https://driftlock.net/api
    description: Production API
  - url: http://localhost:8080
    description: Local development

tags:
  - name: Health
    description: Health and readiness checks
  - name: Demo
    description: Try Driftlock without signing up
  - name: Onboarding
    description: Sign up and verify your account
  - name: Detection
    description: Submit events for anomaly detection
  - name: Anomalies
    description: Query and export detected anomalies
  - name: Dashboard
    description: Manage your account and API keys
  - name: Billing
    description: Subscription and payment management
  - name: Streams
    description: Stream-level configuration and anchors

paths:
  # ═══════════════════════════════════════════════════════════════════════════
  # HEALTH CHECKS (Public)
  # ═══════════════════════════════════════════════════════════════════════════
  /healthz:
    get:
      tags: [Health]
      summary: Health check
      description: Returns service health status. Use for liveness probes.
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /readyz:
    get:
      tags: [Health]
      summary: Readiness check
      description: Returns readiness status including database connectivity. Use for readiness probes.
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                  database:
                    type: string
                    enum: [connected, disconnected]

  # ═══════════════════════════════════════════════════════════════════════════
  # DEMO (Public - Rate Limited)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/demo/detect:
    post:
      tags: [Demo]
      summary: Demo anomaly detection (no auth required)
      description: |
        Try Driftlock without signing up. Results are NOT persisted.

        ## Demo Limitations
        - **Stateless**: No baseline persistence across requests
        - **Max events**: 200 per request
        - **Rate limit**: 10 requests/minute per IP
        - **No calibration tracking**: Each request starts fresh

        ## Data Format
        - Events **must be valid JSON objects**
        - Plain text strings must be wrapped: `{"text": "your message"}`

        ## Best Use
        Demo is ideal for testing the API format and seeing response structure.
        For actual anomaly detection, sign up for a free account to enable
        baseline persistence and calibration tracking.
      operationId: demoDetect
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DetectRequest'
            example:
              events:
                - body: { message: "User logged in", level: "info" }
                - body: { message: "Database query completed", level: "info" }
                - body: { message: "CRITICAL: Unauthorized access attempt", level: "error" }
      responses:
        '200':
          description: Detection results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemoDetectResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/RateLimited'

  /v1/waitlist:
    post:
      tags: [Demo]
      summary: Join the waitlist
      description: Sign up for the pre-launch waitlist.
      operationId: joinWaitlist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
                source:
                  type: string
                  description: Where the user heard about Driftlock
      responses:
        '200':
          description: Added to waitlist
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '429':
          $ref: '#/components/responses/RateLimited'

  # ═══════════════════════════════════════════════════════════════════════════
  # ONBOARDING (Public - Rate Limited)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/onboard/signup:
    post:
      tags: [Onboarding]
      summary: Create a new account
      description: |
        Sign up for Driftlock. A verification email will be sent.

        **Rate limit**: 5 requests/hour per IP
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, company_name]
              properties:
                email:
                  type: string
                  format: email
                company_name:
                  type: string
                  minLength: 1
                plan:
                  type: string
                  enum: [trial, pulse, radar, tensor, orbit]
                  default: trial
            example:
              email: dev@example.com
              company_name: Acme Corp
              plan: trial
      responses:
        '200':
          description: Signup successful - check email for verification
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  tenant_id:
                    type: string
                    format: uuid
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          $ref: '#/components/responses/RateLimited'

  /v1/onboard/verify:
    get:
      tags: [Onboarding]
      summary: Verify email address
      description: Verify email and receive your API key. Link is sent in verification email.
      operationId: verifyEmail
      parameters:
        - name: token
          in: query
          required: true
          schema:
            type: string
          description: Verification token from email
      responses:
        '200':
          description: Email verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  api_key:
                    type: string
                    description: Your API key (store securely!)
                    example: dlk_abc123-def456.secretkey789
        '400':
          $ref: '#/components/responses/BadRequest'
        '410':
          description: Token expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/onboard/resend-verification:
    post:
      tags: [Onboarding]
      summary: Resend verification email
      description: Request a new verification email. Rate limited to 3/hour.
      operationId: resendVerification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Verification email sent (if account exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '429':
          $ref: '#/components/responses/RateLimited'

  # ═══════════════════════════════════════════════════════════════════════════
  # DETECTION (API Key Auth)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/detect:
    post:
      tags: [Detection]
      summary: Detect anomalies in events
      description: |
        Submit a batch of JSON events for anomaly detection using CBAD
        (Compression-Based Anomaly Detection).

        ## How It Works
        Events are compressed using zstd/lz4/gzip and compared against a baseline
        window using Normalized Compression Distance (NCD). Statistical significance
        is determined via permutation testing.

        ## Calibration & Detection Readiness
        Detection requires sufficient data. Thresholds vary by profile:

        | Profile | Baseline | Window | Detection Ready |
        |---------|----------|--------|-----------------|
        | sensitive | 200 | 30 | 230 events |
        | balanced (default) | 400 | 50 | 450 events |
        | strict | 800 | 100 | 900 events |

        Additionally:
        - **Adaptive windowing** auto-adjusts these based on stream characteristics
        - **Auto-tuning** learns optimal thresholds from feedback
        - **Per-request overrides** can customize via `config_override`

        Response fields during warm-up:
        - `status`: "calibrating" (< 50 events) or "ready"
        - `detection_ready`: true when baseline + window collected
        - `detection_events_needed`: events remaining until detection active
        - `calibration`: detailed progress info

        ## Data Format
        - Events **must be valid JSON objects**
        - Plain text strings must be wrapped: `{"text": "your message"}`
        - Arrays of events are supported
        - Nested objects are flattened for compression analysis

        ## Limits
        - **Max events per request**: 10,000 (configurable; demo endpoint: 200)
        - **Max body size**: 10MB
      operationId: detect
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DetectRequest'
            example:
              stream_id: logs-production
              events:
                - body: { level: "info", message: "Request processed", latency_ms: 45 }
                - body: { level: "info", message: "Request processed", latency_ms: 52 }
                - body: { level: "error", message: "Connection timeout", latency_ms: 30000 }
              config_override:
                ncd_threshold: 0.3
                p_value_threshold: 0.05
      responses:
        '200':
          description: Detection results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetectResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimited'

  # ═══════════════════════════════════════════════════════════════════════════
  # STREAM ANCHORS (API Key Auth)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/streams/{id}/anchor:
    get:
      summary: Get anchor settings and status
      tags: [Streams]
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Anchor settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnchorSettingsResponse'
    delete:
      summary: Deactivate anchor (disables drift detection)
      tags: [Streams]
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Anchor deactivated

  /v1/streams/{id}/anchor/details:
    get:
      summary: Get full anchor data including metrics
      tags: [Streams]
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Anchor details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnchorDetailsResponse'

  /v1/streams/{id}/reset-anchor:
    post:
      summary: Create new anchor from provided events
      tags: [Streams]
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetAnchorRequest'
      responses:
        '200':
          description: Anchor created
        '412':
          description: Stream not calibrated

  # ═══════════════════════════════════════════════════════════════════════════
  # ANOMALIES (API Key Auth)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/anomalies:
    get:
      tags: [Anomalies]
      summary: List detected anomalies
      description: Query anomalies with optional filtering by stream, time range, and status.
      operationId: listAnomalies
      security:
        - ApiKeyAuth: []
      parameters:
        - name: stream_id
          in: query
          schema:
            type: string
          description: Filter by stream ID
        - name: from
          in: query
          schema:
            type: string
            format: date-time
          description: Start of time range (ISO 8601)
        - name: to
          in: query
          schema:
            type: string
            format: date-time
          description: End of time range (ISO 8601)
        - name: status
          in: query
          schema:
            type: string
            enum: [open, acknowledged, resolved]
          description: Filter by status
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: Max results to return
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of results to skip
      responses:
        '200':
          description: List of anomalies
          content:
            application/json:
              schema:
                type: object
                properties:
                  anomalies:
                    type: array
                    items:
                      $ref: '#/components/schemas/Anomaly'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/anomalies/{id}:
    get:
      tags: [Anomalies]
      summary: Get anomaly details
      description: Get full details of a specific anomaly including evidence.
      operationId: getAnomaly
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Anomaly ID
      responses:
        '200':
          description: Anomaly details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnomalyDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/anomalies/export:
    post:
      tags: [Anomalies]
      summary: Export anomalies (bulk)
      description: Export multiple anomalies as an evidence bundle.
      operationId: exportAnomalies
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                anomaly_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
                format:
                  type: string
                  enum: [json, pdf, markdown]
                  default: json
      responses:
        '202':
          description: Export job queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    format: uuid
                  status:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/anomalies/{id}/export:
    post:
      tags: [Anomalies]
      summary: Export single anomaly
      description: Export a single anomaly as an evidence bundle.
      operationId: exportAnomaly
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [json, pdf, markdown]
                  default: json
      responses:
        '202':
          description: Export job queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    format: uuid
                  status:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ═══════════════════════════════════════════════════════════════════════════
  # DASHBOARD (Firebase Auth)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/me/keys:
    get:
      tags: [Dashboard]
      summary: List API keys
      description: List all API keys for your account.
      operationId: listApiKeys
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        name:
                          type: string
                        prefix:
                          type: string
                          description: First 8 chars of key for identification
                        created_at:
                          type: string
                          format: date-time
                        last_used_at:
                          type: string
                          format: date-time
                        is_primary:
                          type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/me/keys/create:
    post:
      tags: [Dashboard]
      summary: Create a new API key
      description: Create an additional API key for your account.
      operationId: createApiKey
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Friendly name for the key
      responses:
        '200':
          description: API key created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  key:
                    type: string
                    description: Full API key (only shown once!)
                  key_id:
                    type: string
                    format: uuid
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/me/keys/regenerate:
    post:
      tags: [Dashboard]
      summary: Regenerate API key
      description: Regenerate your primary API key. The old key will be revoked.
      operationId: regenerateApiKey
      security:
        - BearerAuth: []
      responses:
        '200':
          description: API key regenerated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  new_key:
                    type: string
                    description: New API key (only shown once!)
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/me/keys/revoke:
    post:
      tags: [Dashboard]
      summary: Revoke an API key
      description: Revoke a specific API key.
      operationId: revokeApiKey
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [key_id]
              properties:
                key_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: API key revoked
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/me/usage:
    get:
      tags: [Dashboard]
      summary: Get usage summary
      description: Get your current usage statistics.
      operationId: getUsage
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Usage summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsageSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/me/usage/details:
    get:
      tags: [Dashboard]
      summary: Get detailed usage
      description: Get detailed usage with daily breakdown and per-stream stats.
      operationId: getUsageDetails
      security:
        - BearerAuth: []
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 90
            default: 30
          description: Number of days of history
      responses:
        '200':
          description: Detailed usage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsageDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/me/billing:
    get:
      tags: [Dashboard]
      summary: Get billing status
      description: Get your current billing status, plan, and trial info.
      operationId: getBillingStatus
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Billing status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BillingStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ═══════════════════════════════════════════════════════════════════════════
  # BILLING (Mixed Auth)
  # ═══════════════════════════════════════════════════════════════════════════
  /v1/billing/checkout:
    post:
      tags: [Billing]
      summary: Create checkout session
      description: Create a Stripe checkout session to upgrade your plan.
      operationId: createCheckout
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [plan]
              properties:
                plan:
                  type: string
                  enum: [radar, tensor, orbit]
                success_url:
                  type: string
                  format: uri
                cancel_url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  checkout_url:
                    type: string
                    format: uri
                  session_id:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/billing/portal:
    post:
      tags: [Billing]
      summary: Open billing portal
      description: Get a link to the Stripe customer portal to manage subscription.
      operationId: billingPortal
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Portal URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  portal_url:
                    type: string
                    format: uri
        '401':
          $ref: '#/components/responses/Unauthorized'

  /v1/billing/webhook:
    post:
      tags: [Billing]
      summary: Stripe webhook (internal)
      description: |
        Receives Stripe webhook events. **Do not call directly.**

        Requires `Stripe-Signature` header for verification.
      operationId: stripeWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '400':
          description: Invalid signature

  /v1/anomalies/{id}/feedback:
    post:
      tags: [Anomalies]
      summary: Record anomaly feedback
      description: |
        Submit feedback for a detected anomaly to improve auto-tuning.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Anomaly ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
      responses:
        '200':
          description: Feedback recorded
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/streams/{id}/profile:
    get:
      tags: [Streams]
      summary: Get stream detection profile
      description: Requires ApiKeyAuth (X-Api-Key).
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Stream ID
      responses:
        '200':
          description: Current profile and thresholds
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StreamProfileResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags: [Streams]
      summary: Update detection profile
      description: Requires ApiKeyAuth (X-Api-Key).
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                profile:
                  type: string
                  enum: [sensitive, balanced, strict, custom]
                auto_tune_enabled:
                  type: boolean
                adaptive_window_enabled:
                  type: boolean
      responses:
        '200':
          description: Profile updated
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/streams/{id}/tuning:
    get:
      tags: [Streams]
      summary: Get tuning history and feedback stats
      description: Requires ApiKeyAuth (X-Api-Key).
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Tuning settings and history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StreamTuningResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /v1/profiles:
    get:
      tags: [Streams]
      summary: List detection profiles
      responses:
        '200':
          description: Available profiles
          content:
            application/json:
              schema:
                type: object
                properties:
                  profiles:
                    type: object
                    additionalProperties:
                      $ref: '#/components/schemas/ProfileSummary'

# ═══════════════════════════════════════════════════════════════════════════════
# COMPONENTS
# ═══════════════════════════════════════════════════════════════════════════════
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key
      description: |
        API key in format `dlk_<uuid>.<secret>`

        Get your key from the dashboard or via email verification.
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Firebase ID token from client-side Firebase Auth

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              description: Machine-readable error code
              enum:
                - invalid_argument
                - unauthorized
                - forbidden
                - not_found
                - method_not_allowed
                - conflict
                - gone
                - rate_limit_exceeded
                - internal
                - service_unavailable
            message:
              type: string
              description: Human-readable error message
            request_id:
              type: string
              description: Request ID for debugging
            retry_after_seconds:
              type: integer
              description: Seconds to wait (only for rate_limit_exceeded)

    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
        version:
          type: string
        library_status:
          type: string
          enum: [healthy, unhealthy]
        openzl_available:
          type: boolean

    DetectRequest:
      type: object
      required: [events]
      properties:
        stream_id:
          type: string
          description: |
            Logical stream identifier (e.g., "logs-production", "api-requests").
            Creates a new stream if not exists. Uses default stream if omitted.
        events:
          type: array
          description: Array of JSON events to analyze
          items:
            type: object
            additionalProperties: true
          minItems: 1
          maxItems: 1000
        config_override:
          $ref: '#/components/schemas/ConfigOverride'

    ConfigOverride:
      type: object
      description: Override default detection settings for this request
      properties:
        baseline_size:
          type: integer
          description: Number of events in baseline window
          default: 400
          minimum: 10
          maximum: 10000
        window_size:
          type: integer
          description: Number of events in analysis window
          default: 50
          minimum: 5
          maximum: 1000
        hop_size:
          type: integer
          description: Hop size for sliding window
          default: 10
          minimum: 1
        ncd_threshold:
          type: number
          description: NCD threshold for anomaly detection (0-1)
          default: 0.3
          minimum: 0
          maximum: 1
        p_value_threshold:
          type: number
          description: p-value threshold for statistical significance
          default: 0.05
          minimum: 0
          maximum: 1
        permutation_count:
          type: integer
          description: Number of permutations for statistical testing
          default: 1000
          minimum: 100
          maximum: 10000
        compressor:
          type: string
          description: Compression algorithm
          enum: [zlab, zstd, lz4, gzip, openzl]
          default: zstd

    DetectResponse:
      type: object
      properties:
        success:
          type: boolean
        batch_id:
          type: string
          format: uuid
          description: Unique ID for this detection batch
        stream_id:
          type: string
          format: uuid
          description: Stream the events were processed in
        total_events:
          type: integer
          description: Number of events processed
        anomaly_count:
          type: integer
          description: Number of anomalies detected
        processing_time:
          type: string
          description: Time taken to process (e.g., "245ms")
        compression_algo:
          type: string
          description: Compression algorithm used
        fallback_from_algo:
          type: string
          description: Original algorithm if fallback occurred
        request_id:
          type: string
          description: Request ID for debugging
        status:
          type: string
          enum: [calibrating, ready]
          description: |
            Stream calibration status:
            - `calibrating`: Still collecting baseline events (< min_baseline_size)
            - `ready`: Baseline collected, detection active
        detection_ready:
          type: boolean
          description: |
            True when detector has enough data (450+ events by default).
            Note: `status` can be "ready" while `detection_ready` is false during
            the warmup period between calibration (50 events) and full detection (450 events).
        detection_events_needed:
          type: integer
          description: Number of additional events needed before detection can work (0 when ready)
        calibration:
          $ref: '#/components/schemas/CalibrationInfo'
        anomalies:
          type: array
          items:
            $ref: '#/components/schemas/AnomalyOutput'
        drift:
          $ref: '#/components/schemas/DriftResult'
        value_outliers:
          type: array
          items:
            $ref: '#/components/schemas/ValueOutlier'

    DemoDetectResponse:
      allOf:
        - $ref: '#/components/schemas/DetectResponse'
        - type: object
          properties:
            demo:
              type: object
              properties:
                message:
                  type: string
                remaining_calls:
                  type: integer
                limit_per_minute:
                  type: integer
                max_events_per_request:
                  type: integer
                signup_url:
                  type: string
                  format: uri

    CalibrationInfo:
      type: object
      description: |
        Detailed calibration status for a stream. Shows progress toward both
        baseline calibration (50 events) and detection readiness (varies by profile:
        sensitive=230, balanced=450, strict=900, or custom/adaptive values).
      properties:
        events_ingested:
          type: integer
          format: int64
          description: Total events ingested into this stream
        events_needed:
          type: integer
          format: int64
          description: Events remaining for baseline calibration (0 when calibrated)
        min_baseline_size:
          type: integer
          description: Minimum events required for baseline calibration (default 50)
        progress_percent:
          type: integer
          minimum: 0
          maximum: 100
          description: Calibration progress percentage (0-100)
        detection_ready:
          type: boolean
          description: Whether detector has enough data for anomaly detection
        detection_events_needed:
          type: integer
          format: int64
          description: Events remaining until detection is ready (0 when ready)
        detection_min_events:
          type: integer
          description: Minimum events for detection (profile-dependent, adaptive, or custom)
        message:
          type: string
          description: Human-readable status message

    AnomalyOutput:
      type: object
      properties:
        id:
          type: string
          format: uuid
        index:
          type: integer
          description: Position in input array
        detected:
          type: boolean
          description: Whether this event is anomalous
        why:
          type: string
          description: Human-readable explanation
        event:
          type: object
          description: The original event
        metrics:
          $ref: '#/components/schemas/AnomalyMetrics'

    AnomalyMetrics:
      type: object
      description: Statistical metrics for the anomaly
      properties:
        ncd:
          type: number
          description: Normalized Compression Distance (0-1, higher = more anomalous)
        p_value:
          type: number
          description: Statistical significance (lower = more significant)
        confidence_level:
          type: number
          description: Confidence level (1 - p_value)
        baseline_compression_ratio:
          type: number
          description: Compression ratio of baseline
        window_compression_ratio:
          type: number
          description: Compression ratio of window
        baseline_entropy:
          type: number
          description: Shannon entropy of baseline
        window_entropy:
          type: number
          description: Shannon entropy of window
        entropy_change:
          type: number
          description: Change in entropy (window - baseline)
        compression_ratio_change:
          type: number
          description: Change in compression ratio
        is_statistically_significant:
          type: boolean
          description: Whether p_value < threshold

    Anomaly:
      type: object
      properties:
        id:
          type: string
          format: uuid
        stream_id:
          type: string
          format: uuid
        detected_at:
          type: string
          format: date-time
        status:
          type: string
          enum: [open, acknowledged, resolved]
        ncd:
          type: number
        p_value:
          type: number
        confidence:
          type: number
        explanation:
          type: string

    AnomalyDetail:
      allOf:
        - $ref: '#/components/schemas/Anomaly'
        - type: object
          properties:
            event:
              type: object
            metrics:
              $ref: '#/components/schemas/AnomalyMetrics'
            evidence:
              type: array
              items:
                type: object
                properties:
                  format:
                    type: string
                  uri:
                    type: string
                  checksum:
                    type: string

    AnchorSettingsResponse:
      type: object
      properties:
        anchor_enabled:
          type: boolean
        drift_ncd_threshold:
          type: number
        anchor_reset_on_drift:
          type: boolean
        has_active_anchor:
          type: boolean
        anchor_id:
          type: string
          format: uuid
          nullable: true

    AnchorDetailsResponse:
      type: object
      properties:
        anchor:
          $ref: '#/components/schemas/AnchorResponse'
          nullable: true
        message:
          type: string

    AnchorResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        stream_id:
          type: string
          format: uuid
        compressor:
          type: string
        event_count:
          type: integer
        calibration_completed_at:
          type: string
          format: date-time
        is_active:
          type: boolean
        baseline_entropy:
          type: number
          nullable: true
        baseline_compression_ratio:
          type: number
          nullable: true
        drift_ncd_threshold:
          type: number
        created_at:
          type: string
          format: date-time

    ResetAnchorRequest:
      type: object
      required:
        - events
      properties:
        force_reset:
          type: boolean
          default: false
        events:
          type: array
          items:
            type: object
          minItems: 1

    DriftResult:
      type: object
      nullable: true
      properties:
        anchor_id:
          type: string
          format: uuid
        drift_score:
          type: number
        drift_threshold:
          type: number
        drift_detected:
          type: boolean
        baseline_events:
          type: integer
        window_events:
          type: integer
        anchor_created_at:
          type: string
          format: date-time
        diagnostic_reason:
          type: string
          enum: [no_active_anchor, anchor_decode_failed, window_snapshot_failed, drift_compute_failed]

    ValueOutlier:
      type: object
      properties:
        field_path:
          type: string
        value:
          type: number
        expected_mean:
          type: number
        std_dev:
          type: number
        z_score:
          type: number
        sample_count:
          type: integer

    UsageSummary:
      type: object
      properties:
        events_this_month:
          type: integer
        anomalies_this_month:
          type: integer
        events_limit:
          type: integer
        percentage_used:
          type: number

    UsageDetails:
      type: object
      properties:
        summary:
          $ref: '#/components/schemas/UsageSummary'
        daily:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              events:
                type: integer
              anomalies:
                type: integer
        streams:
          type: array
          items:
            type: object
            properties:
              stream_id:
                type: string
              stream_name:
                type: string
              events:
                type: integer
              anomalies:
                type: integer
              anomaly_rate:
                type: number

    BillingStatus:
      type: object
      properties:
        status:
          type: string
          enum: [active, trialing, past_due, canceled, grace_period]
        plan:
          type: string
          enum: [pulse, radar, tensor, orbit]
        trial_days_remaining:
          type: integer
          description: Days left in trial (null if not trialing)
        grace_period_ends_at:
          type: string
          format: date-time
          description: When grace period ends (null if not in grace period)
        current_period_end:
          type: string
          format: date-time

    FeedbackRequest:
      type: object
      required:
        - feedback_type
      properties:
        feedback_type:
          type: string
          enum: [false_positive, confirmed, dismissed]
        reason:
          type: string
          description: Optional user-supplied reason

    ProfileSummary:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        ncd_threshold:
          type: number
        pvalue_threshold:
          type: number
        baseline_size:
          type: integer
        window_size:
          type: integer

    StreamProfileResponse:
      type: object
      properties:
        profile:
          type: string
          enum: [sensitive, balanced, strict, custom]
        auto_tune_enabled:
          type: boolean
        adaptive_window_enabled:
          type: boolean
        current_thresholds:
          type: object
          properties:
            ncd_threshold:
              type: number
            pvalue_threshold:
              type: number
            baseline_size:
              type: integer
            window_size:
              type: integer
        profile_descriptions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ProfileSummary'

    StreamTuningResponse:
      type: object
      properties:
        current_settings:
          $ref: '#/components/schemas/StreamProfileResponse'
        tune_history:
          type: array
          items:
            type: object
            properties:
              tune_type:
                type: string
              old_value:
                type: number
              new_value:
                type: number
              reason:
                type: string
              confidence:
                type: number
              created_at:
                type: string
                format: date-time
        feedback_stats:
          type: object
          properties:
            total_feedback:
              type: integer
            false_positives:
              type: integer
            confirmed:
              type: integer
            dismissed:
              type: integer
            false_positive_rate:
              type: number
