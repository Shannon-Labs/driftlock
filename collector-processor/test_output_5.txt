# github.com/Shannon-Labs/driftlock/collector-processor/cmd/driftlock-http.test
ld: warning: ignoring duplicate libraries: '-lcbad_core'
=== RUN   TestBillingStatusEndpoint
    e2e_billing_test.go:17: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestBillingStatusEndpoint (0.03s)
=== RUN   TestCheckoutSessionCreation
    e2e_billing_test.go:72: STRIPE_SECRET_KEY not set, skipping checkout test
--- SKIP: TestCheckoutSessionCreation (0.00s)
=== RUN   TestTrialCountdownAccuracy
    e2e_billing_test.go:135: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestTrialCountdownAccuracy (0.03s)
=== RUN   TestGracePeriodLogic
    e2e_billing_test.go:193: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestGracePeriodLogic (0.03s)
=== RUN   TestWebhookSignatureRequired
    e2e_billing_test.go:280: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestWebhookSignatureRequired (0.02s)
=== RUN   TestOnboardingFlow
    e2e_onboarding_test.go:12: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestOnboardingFlow (0.02s)
=== RUN   TestSignupValidation
    e2e_onboarding_test.go:89: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestSignupValidation (0.02s)
=== RUN   TestDuplicateEmailRejected
    e2e_onboarding_test.go:143: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestDuplicateEmailRejected (0.02s)
=== RUN   TestVerificationTokenValidation
    e2e_onboarding_test.go:169: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestVerificationTokenValidation (0.02s)
=== RUN   TestSignupRateLimiting
    e2e_onboarding_test.go:187: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestSignupRateLimiting (0.02s)
=== RUN   TestAPIKeyAuthAfterVerification
    e2e_onboarding_test.go:225: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestAPIKeyAuthAfterVerification (0.02s)
=== RUN   TestUnauthorizedDetection
    e2e_onboarding_test.go:287: Failed to run migrations: ERROR 20251201000000_ai_cost_control.sql: failed to run SQL migration: failed to execute SQL query "CREATE OR REPLACE FUNCTION update_ai_usage_limits()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Update daily limit\n    INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)\n    VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)\n    ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET\n        call_count = ai_usage_limits.call_count + 1,\n        total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,\n        updated_at = NOW();": ERROR: unterminated dollar-quoted string at or near "$$
        BEGIN
            -- Update daily limit
            INSERT INTO ai_usage_limits (tenant_id, window_type, window_start, call_count, total_cost)
            VALUES (NEW.tenant_id, 'day', DATE_TRUNC('day', NEW.created_at), 1, NEW.total_charge_usd)
            ON CONFLICT (tenant_id, window_type, window_start) DO UPDATE SET
                call_count = ai_usage_limits.call_count + 1,
                total_cost = ai_usage_limits.total_cost + NEW.total_charge_usd,
                updated_at = NOW();" (SQLSTATE 42601)
--- FAIL: TestUnauthorizedDetection (0.02s)
=== RUN   TestLoadLicenseValid
--- PASS: TestLoadLicenseValid (0.00s)
=== RUN   TestLoadLicenseInvalidSignature
--- PASS: TestLoadLicenseInvalidSignature (0.00s)
=== RUN   TestLoadLicenseExpired
--- PASS: TestLoadLicenseExpired (0.00s)
=== RUN   TestTenantRateLimiter_TenantLimit
--- PASS: TestTenantRateLimiter_TenantLimit (0.00s)
=== RUN   TestTenantRateLimiter_KeyLimit
--- PASS: TestTenantRateLimiter_KeyLimit (0.00s)
=== RUN   TestDecorateRateLimitHeaders
--- PASS: TestDecorateRateLimitHeaders (0.00s)
FAIL
FAIL	github.com/Shannon-Labs/driftlock/collector-processor/cmd/driftlock-http	0.646s
FAIL
