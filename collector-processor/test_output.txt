# github.com/Shannon-Labs/driftlock/collector-processor/cmd/driftlock-http.test
ld: warning: ignoring duplicate libraries: '-lcbad_core'
=== RUN   TestBillingStatusEndpoint
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59457","request_id":"1764646162676064000","ts":"2025-12-01T21:29:22.676076-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=500","error":"failed to create tenant: ERROR: column \"firebase_uid\" of relation \"tenants\" does not exist (SQLSTATE 42703)","error_type":"internal","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59457","request_id":"1764646162676064000","ts":"2025-12-01T21:29:22.67938-06:00"}
2025/12/01 21:29:22 {"details":"status=500","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59457","request_id":"1764646162676064000","ts":"2025-12-01T21:29:22.679477-06:00","user_agent":"Go-http-client/1.1"}
    e2e_billing_test.go:29: Expected status 201, got 500
    e2e_billing_test.go:33: Failed to get verification token: failed to get verification token: no rows in result set
--- FAIL: TestBillingStatusEndpoint (0.02s)
=== RUN   TestCheckoutSessionCreation
    e2e_billing_test.go:72: STRIPE_SECRET_KEY not set, skipping checkout test
--- SKIP: TestCheckoutSessionCreation (0.00s)
=== RUN   TestTrialCountdownAccuracy
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59460","request_id":"1764646162686984000","ts":"2025-12-01T21:29:22.686985-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=500","error":"failed to create tenant: ERROR: column \"firebase_uid\" of relation \"tenants\" does not exist (SQLSTATE 42703)","error_type":"internal","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59460","request_id":"1764646162686984000","ts":"2025-12-01T21:29:22.688528-06:00"}
2025/12/01 21:29:22 {"details":"status=500","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59460","request_id":"1764646162686984000","ts":"2025-12-01T21:29:22.688551-06:00","user_agent":"Go-http-client/1.1"}
    e2e_billing_test.go:147: Expected status 201, got 500
    e2e_billing_test.go:151: Failed to get verification token: failed to get verification token: no rows in result set
--- FAIL: TestTrialCountdownAccuracy (0.01s)
=== RUN   TestGracePeriodLogic
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59463","request_id":"1764646162696352000","ts":"2025-12-01T21:29:22.696353-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=500","error":"failed to create tenant: ERROR: column \"firebase_uid\" of relation \"tenants\" does not exist (SQLSTATE 42703)","error_type":"internal","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59463","request_id":"1764646162696352000","ts":"2025-12-01T21:29:22.698023-06:00"}
2025/12/01 21:29:22 {"details":"status=500","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59463","request_id":"1764646162696352000","ts":"2025-12-01T21:29:22.698115-06:00","user_agent":"Go-http-client/1.1"}
    e2e_billing_test.go:205: Expected status 201, got 500
    e2e_billing_test.go:209: Failed to get verification token: failed to get verification token: no rows in result set
--- FAIL: TestGracePeriodLogic (0.01s)
=== RUN   TestWebhookSignatureRequired
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/billing/webhook","query":"","remote":"127.0.0.1:59466","request_id":"1764646162705788000","ts":"2025-12-01T21:29:22.705789-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 Error verifying webhook signature: webhook has no Stripe-Signature header
2025/12/01 21:29:22 {"details":"status=400","event":"request_complete","method":"POST","path":"/v1/billing/webhook","query":"","remote":"127.0.0.1:59466","request_id":"1764646162705788000","ts":"2025-12-01T21:29:22.705836-06:00","user_agent":"Go-http-client/1.1"}
    e2e_billing_test.go:300: Webhook correctly rejected (status 400)
--- PASS: TestWebhookSignatureRequired (0.01s)
=== RUN   TestOnboardingFlow
=== RUN   TestOnboardingFlow/SignupCreatesUnverifiedTenant
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59469","request_id":"1764646162712135000","ts":"2025-12-01T21:29:22.712135-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=500","error":"failed to create tenant: ERROR: column \"firebase_uid\" of relation \"tenants\" does not exist (SQLSTATE 42703)","error_type":"internal","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59469","request_id":"1764646162712135000","ts":"2025-12-01T21:29:22.713876-06:00"}
2025/12/01 21:29:22 {"details":"status=500","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59469","request_id":"1764646162712135000","ts":"2025-12-01T21:29:22.713891-06:00","user_agent":"Go-http-client/1.1"}
=== NAME  TestOnboardingFlow
    e2e_onboarding_test.go:25: Expected status 201, got 500
    e2e_onboarding_test.go:26: Expected success = true, got <nil>
    e2e_onboarding_test.go:27: Expected pending_verification = true, got <nil>
    e2e_onboarding_test.go:28: Expected verification_sent = true, got <nil>
=== NAME  TestOnboardingFlow/SignupCreatesUnverifiedTenant
    e2e_onboarding_test.go:33: Failed to get tenant status: ERROR: column "email_verified_at" does not exist (SQLSTATE 42703)
=== RUN   TestOnboardingFlow/VerifyActivatesTenant
    e2e_onboarding_test.go:47: Failed to get verification token: failed to get verification token: no rows in result set
--- FAIL: TestOnboardingFlow (0.01s)
    --- FAIL: TestOnboardingFlow/SignupCreatesUnverifiedTenant (0.00s)
    --- FAIL: TestOnboardingFlow/VerifyActivatesTenant (0.00s)
=== RUN   TestSignupValidation
=== RUN   TestSignupValidation/MissingEmail
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162721647000","ts":"2025-12-01T21:29:22.721648-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=400","error":"email is required","error_type":"invalid_argument","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59472","request_id":"1764646162721647000","ts":"2025-12-01T21:29:22.721707-06:00"}
2025/12/01 21:29:22 {"details":"status=400","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162721647000","ts":"2025-12-01T21:29:22.721717-06:00","user_agent":"Go-http-client/1.1"}
=== RUN   TestSignupValidation/InvalidEmail
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162721943000","ts":"2025-12-01T21:29:22.721944-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59472","request_id":"1764646162721943000","ts":"2025-12-01T21:29:22.721956-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162721943000","ts":"2025-12-01T21:29:22.721973-06:00","user_agent":"Go-http-client/1.1"}
=== NAME  TestSignupValidation
    e2e_onboarding_test.go:135: Expected status 400, got 429
    e2e_onboarding_test.go:136: Expected error.message to contain "invalid email format", got "rate limit exceeded: max 5 signups per hour per IP"
=== RUN   TestSignupValidation/MissingCompanyName
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162722116000","ts":"2025-12-01T21:29:22.722116-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59472","request_id":"1764646162722116000","ts":"2025-12-01T21:29:22.722125-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162722116000","ts":"2025-12-01T21:29:22.722138-06:00","user_agent":"Go-http-client/1.1"}
=== NAME  TestSignupValidation
    e2e_onboarding_test.go:135: Expected status 400, got 429
    e2e_onboarding_test.go:136: Expected error.message to contain "company_name is required", got "rate limit exceeded: max 5 signups per hour per IP"
=== RUN   TestSignupValidation/CompanyNameTooShort
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162722240000","ts":"2025-12-01T21:29:22.722241-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59472","request_id":"1764646162722240000","ts":"2025-12-01T21:29:22.72225-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162722240000","ts":"2025-12-01T21:29:22.722259-06:00","user_agent":"Go-http-client/1.1"}
=== NAME  TestSignupValidation
    e2e_onboarding_test.go:135: Expected status 400, got 429
    e2e_onboarding_test.go:136: Expected error.message to contain "at least 2 characters", got "rate limit exceeded: max 5 signups per hour per IP"
=== RUN   TestSignupValidation/InvalidPlan
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162722400000","ts":"2025-12-01T21:29:22.722401-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59472","request_id":"1764646162722400000","ts":"2025-12-01T21:29:22.722409-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59472","request_id":"1764646162722400000","ts":"2025-12-01T21:29:22.722417-06:00","user_agent":"Go-http-client/1.1"}
=== NAME  TestSignupValidation
    e2e_onboarding_test.go:135: Expected status 400, got 429
    e2e_onboarding_test.go:136: Expected error.message to contain "invalid plan", got "rate limit exceeded: max 5 signups per hour per IP"
--- FAIL: TestSignupValidation (0.01s)
    --- PASS: TestSignupValidation/MissingEmail (0.00s)
    --- PASS: TestSignupValidation/InvalidEmail (0.00s)
    --- PASS: TestSignupValidation/MissingCompanyName (0.00s)
    --- PASS: TestSignupValidation/CompanyNameTooShort (0.00s)
    --- PASS: TestSignupValidation/InvalidPlan (0.00s)
=== RUN   TestDuplicateEmailRejected
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59475","request_id":"1764646162729098000","ts":"2025-12-01T21:29:22.729098-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59475","request_id":"1764646162729098000","ts":"2025-12-01T21:29:22.729122-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59475","request_id":"1764646162729098000","ts":"2025-12-01T21:29:22.729138-06:00","user_agent":"Go-http-client/1.1"}
    e2e_onboarding_test.go:155: Expected status 201, got 429
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59475","request_id":"1764646162729254000","ts":"2025-12-01T21:29:22.729255-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59475","request_id":"1764646162729254000","ts":"2025-12-01T21:29:22.729264-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59475","request_id":"1764646162729254000","ts":"2025-12-01T21:29:22.729275-06:00","user_agent":"Go-http-client/1.1"}
    e2e_onboarding_test.go:163: Expected status 409, got 429
    e2e_onboarding_test.go:164: Expected error.message to contain "already registered", got "rate limit exceeded: max 5 signups per hour per IP"
--- FAIL: TestDuplicateEmailRejected (0.01s)
=== RUN   TestVerificationTokenValidation
=== RUN   TestVerificationTokenValidation/MissingToken
2025/12/01 21:29:22 {"event":"request_start","method":"GET","path":"/v1/onboard/verify","query":"","remote":"127.0.0.1:59478","request_id":"1764646162736216000","ts":"2025-12-01T21:29:22.736217-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=400","error":"verification token required","error_type":"invalid_argument","event":"error","method":"GET","path":"/v1/onboard/verify","remote":"127.0.0.1:59478","request_id":"1764646162736216000","ts":"2025-12-01T21:29:22.736237-06:00"}
2025/12/01 21:29:22 {"details":"status=400","event":"request_complete","method":"GET","path":"/v1/onboard/verify","query":"","remote":"127.0.0.1:59478","request_id":"1764646162736216000","ts":"2025-12-01T21:29:22.736247-06:00","user_agent":"Go-http-client/1.1"}
=== RUN   TestVerificationTokenValidation/InvalidToken
2025/12/01 21:29:22 {"event":"request_start","method":"GET","path":"/v1/onboard/verify","query":"token=invalid_token_xyz","remote":"127.0.0.1:59478","request_id":"1764646162736382000","ts":"2025-12-01T21:29:22.736382-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=400","error":"invalid or expired verification token","error_type":"invalid_argument","event":"error","method":"GET","path":"/v1/onboard/verify","remote":"127.0.0.1:59478","request_id":"1764646162736382000","ts":"2025-12-01T21:29:22.737153-06:00"}
2025/12/01 21:29:22 {"details":"status=400","event":"request_complete","method":"GET","path":"/v1/onboard/verify","query":"token=invalid_token_xyz","remote":"127.0.0.1:59478","request_id":"1764646162736382000","ts":"2025-12-01T21:29:22.737166-06:00","user_agent":"Go-http-client/1.1"}
--- PASS: TestVerificationTokenValidation (0.01s)
    --- PASS: TestVerificationTokenValidation/MissingToken (0.00s)
    --- PASS: TestVerificationTokenValidation/InvalidToken (0.00s)
=== RUN   TestSignupRateLimiting
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59481","request_id":"1764646162743975000","ts":"2025-12-01T21:29:22.743976-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59481","request_id":"1764646162743975000","ts":"2025-12-01T21:29:22.743994-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59481","request_id":"1764646162743975000","ts":"2025-12-01T21:29:22.744005-06:00","user_agent":"Go-http-client/1.1"}
    e2e_onboarding_test.go:206: Rate limited at request 1
--- PASS: TestSignupRateLimiting (0.01s)
=== RUN   TestAPIKeyAuthAfterVerification
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59484","request_id":"1764646162751164000","ts":"2025-12-01T21:29:22.751164-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=429","error":"rate limit exceeded: max 5 signups per hour per IP","error_type":"rate_limit_exceeded","event":"error","method":"POST","path":"/v1/onboard/signup","remote":"127.0.0.1:59484","request_id":"1764646162751164000","ts":"2025-12-01T21:29:22.751185-06:00"}
2025/12/01 21:29:22 {"details":"status=429","event":"request_complete","method":"POST","path":"/v1/onboard/signup","query":"","remote":"127.0.0.1:59484","request_id":"1764646162751164000","ts":"2025-12-01T21:29:22.751197-06:00","user_agent":"Go-http-client/1.1"}
    e2e_onboarding_test.go:237: Expected status 201, got 429
    e2e_onboarding_test.go:242: Failed to get verification token: failed to get verification token: no rows in result set
--- FAIL: TestAPIKeyAuthAfterVerification (0.01s)
=== RUN   TestUnauthorizedDetection
2025/12/01 21:29:22 {"event":"request_start","method":"POST","path":"/v1/detect","query":"","remote":"127.0.0.1:59487","request_id":"1764646162758887000","ts":"2025-12-01T21:29:22.758887-06:00","user_agent":"Go-http-client/1.1"}
2025/12/01 21:29:22 {"details":"http_status=401","error":"missing api key","error_type":"unauthorized","event":"error","method":"POST","path":"/v1/detect","remote":"127.0.0.1:59487","request_id":"1764646162758887000","ts":"2025-12-01T21:29:22.758901-06:00"}
2025/12/01 21:29:22 {"details":"status=401","event":"request_complete","method":"POST","path":"/v1/detect","query":"","remote":"127.0.0.1:59487","request_id":"1764646162758887000","ts":"2025-12-01T21:29:22.758908-06:00","user_agent":"Go-http-client/1.1"}
--- PASS: TestUnauthorizedDetection (0.01s)
=== RUN   TestLoadLicenseValid
--- PASS: TestLoadLicenseValid (0.00s)
=== RUN   TestLoadLicenseInvalidSignature
--- PASS: TestLoadLicenseInvalidSignature (0.00s)
=== RUN   TestLoadLicenseExpired
--- PASS: TestLoadLicenseExpired (0.00s)
=== RUN   TestTenantRateLimiter_TenantLimit
--- PASS: TestTenantRateLimiter_TenantLimit (0.00s)
=== RUN   TestTenantRateLimiter_KeyLimit
--- PASS: TestTenantRateLimiter_KeyLimit (0.00s)
=== RUN   TestDecorateRateLimitHeaders
--- PASS: TestDecorateRateLimitHeaders (0.00s)
FAIL
FAIL	github.com/Shannon-Labs/driftlock/collector-processor/cmd/driftlock-http	0.485s
FAIL
