<template>
  <div class="ai-usage-widget">
    <div class="widget-header">
      <h3>AI Usage & Costs</h3>
      <div class="model-badge" :class="`model-${currentModel}`">
        {{ modelDisplayName }}
      </div>
    </div>

    <!-- Current Period Usage -->
    <div class="usage-section">
      <div class="usage-header">
        <span class="period-label">Current Period</span>
        <span class="period-dates">{{ periodDates }}</span>
      </div>

      <!-- Usage Bars -->
      <div class="usage-metrics">
        <!-- Calls Usage -->
        <div class="metric">
          <div class="metric-header">
            <span>AI Calls</span>
            <span class="metric-value">{{ usage.callsUsed }} / {{ usage.callsLimit }}</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              :class="getUsageClass(usage.callsPercent)"
              :style="{ width: `${Math.min(usage.callsPercent, 100)}%` }"
            ></div>
          </div>
        </div>

        <!-- Cost Usage -->
        <div class="metric">
          <div class="metric-header">
            <span>AI Costs</span>
            <span class="metric-value">${{ usage.costUsed.toFixed(2) }} / ${{ usage.costLimit.toFixed(2) }}</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill cost"
              :class="getUsageClass(usage.costPercent)"
              :style="{ width: `${Math.min(usage.costPercent, 100)}%` }"
            ></div>
          </div>
        </div>
      </div>

      <!-- Token Usage -->
      <div class="token-breakdown">
        <div class="token-item">
          <span class="token-label">Input Tokens</span>
          <span class="token-value">{{ formatNumber(usage.inputTokens) }}</span>
        </div>
        <div class="token-item">
          <span class="token-label">Output Tokens</span>
          <span class="token-value">{{ formatNumber(usage.outputTokens) }}</span>
        </div>
        <div class="token-item">
          <span class="token-label">Total</span>
          <span class="token-value">{{ formatNumber(usage.inputTokens + usage.outputTokens) }}</span>
        </div>
      </div>
    </div>

    <!-- Cost Breakdown -->
    <div class="cost-breakdown" v-if="showBreakdown">
      <h4>Cost Breakdown</h4>
      <div class="breakdown-item">
        <span>Infrastructure Costs</span>
        <span>${{ infrastructureCost.toFixed(2) }}</span>
      </div>
      <div class="breakdown-item">
        <span>AI Processing Costs</span>
        <span>${{ aiCost.toFixed(2) }}</span>
      </div>
      <div class="breakdown-item">
        <span>Margin (15%)</span>
        <span>${{ marginCost.toFixed(2) }}</span>
      </div>
      <div class="breakdown-item total">
        <span>Total Charges</span>
        <span>${{ totalCost.toFixed(2) }}</span>
      </div>
    </div>

    <!-- Forecast -->
    <div class="forecast-section">
      <div class="forecast-header">
        <span>Monthly Forecast</span>
        <button @click="showBreakdown = !showBreakdown" class="toggle-btn">
          {{ showBreakdown ? 'Hide' : 'Show' }} Details
        </button>
      </div>
      <div class="forecast-amount">
        <span class="estimated">Estimated Total:</span>
        <span class="amount">${{ forecastTotal.toFixed(2) }}</span>
      </div>
      <div class="forecast-note" v-if="forecastWarning">
        <i class="fas fa-exclamation-triangle"></i>
        {{ forecastWarning }}
      </div>
    </div>

    <!-- Alerts -->
    <div class="alerts" v-if="alerts.length > 0">
      <div
        v-for="alert in alerts"
        :key="alert.id"
        class="alert"
        :class="alert.severity"
      >
        <i :class="alertIcon(alert.severity)"></i>
        {{ alert.message }}
      </div>
    </div>

    <!-- Upgrade Prompt -->
    <div class="upgrade-prompt" v-if="showUpgradePrompt">
      <p>You're approaching your AI usage limits. Upgrade your plan for more AI-powered insights.</p>
      <button @click="$emit('upgrade')" class="upgrade-btn">
        Upgrade Plan
      </button>
    </div>

    <!-- Configure AI Settings -->
    <div class="config-section">
      <button @click="showConfig = !showConfig" class="config-btn">
        <i class="fas fa-cog"></i> Configure AI
      </button>

      <div v-if="showConfig" class="config-panel">
        <div class="config-item">
          <label>Analysis Threshold</label>
          <input
            type="range"
            min="0.1"
            max="1.0"
            step="0.1"
            v-model="localConfig.threshold"
            @change="updateConfig"
          />
          <span>{{ localConfig.threshold }}</span>
        </div>
        <div class="config-item">
          <label>Optimize For</label>
          <select v-model="localConfig.optimizeFor" @change="updateConfig">
            <option value="cost">Cost</option>
            <option value="speed">Speed</option>
            <option value="accuracy">Accuracy</option>
          </select>
        </div>
        <div class="config-item">
          <label>Max Cost/Month</label>
          <input
            type="number"
            v-model="localConfig.maxCost"
            @change="updateConfig"
            :disabled="!canEditMaxCost"
          />
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import { ref, computed, onMounted, watch } from 'vue'
import { useDashboardStore } from '@/stores/dashboard'

export default {
  name: 'AIUsageWidget',
  emits: ['upgrade', 'config-changed'],

  setup(props, { emit }) {
    const dashboardStore = useDashboardStore()

    // State
    const showBreakdown = ref(false)
    const showConfig = ref(false)
    const alerts = ref([])
    const usage = ref({
      callsUsed: 0,
      callsLimit: 0,
      callsPercent: 0,
      costUsed: 0,
      costLimit: 0,
      costPercent: 0,
      inputTokens: 0,
      outputTokens: 0
    })

    const localConfig = ref({
      threshold: 0.7,
      optimizeFor: 'cost',
      maxCost: 100
    })

    // Computed
    const periodDates = computed(() => {
      const now = new Date()
      const start = new Date(now.getFullYear(), now.getMonth(), 1)
      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0)
      return `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`
    })

    const currentModel = computed(() => {
      // Based on plan and usage
      if (usage.value.callsLimit >= 5000) return 'sonnet-4.5'
      if (usage.value.callsLimit >= 1000) return 'haiku-4.5'
      return 'none'
    })

    const modelDisplayName = computed(() => {
      const names = {
        'haiku-4.5': 'Haiku 4.5',
        'sonnet-4.5': 'Sonnet 4.5',
        'opus-4.5': 'Opus 4.5',
        'none': 'AI Disabled'
      }
      return names[currentModel.value] || 'Unknown'
    })

    const showUpgradePrompt = computed(() => {
      return usage.value.callsPercent > 80 || usage.value.costPercent > 80
    })

    const canEditMaxCost = computed(() => {
      // Only enterprise plans can edit max cost
      return dashboardStore.userPlan === 'orbit'
    })

    // Cost calculations
    const infrastructureCost = computed(() => {
      // Based on event count
      const events = dashboardStore.usage.events || 0
      return (events / 10000) * 0.001 // $0.001 per 10K events
    })

    const aiCost = computed(() => usage.value.costUsed)
    const marginCost = computed(() => (infrastructureCost.value + aiCost.value) * 0.15)
    const totalCost = computed(() => infrastructureCost.value + aiCost.value + marginCost.value)

    const forecastTotal = computed(() => {
      const daysInMonth = 30
      const daysPassed = new Date().getDate()
      const dailyRate = totalCost.value / daysPassed
      return dailyRate * daysInMonth
    })

    const forecastWarning = computed(() => {
      if (forecastTotal.value > usage.value.costLimit * 0.9) {
        return 'You may exceed your monthly budget at this rate'
      }
      return null
    })

    // Methods
    const fetchUsage = async () => {
      try {
        const response = await fetch('/api/v1/me/usage/ai')
        const data = await response.json()

        usage.value = {
          callsUsed: data.calls_used || 0,
          callsLimit: data.calls_limit || 0,
          callsPercent: (data.calls_used / data.calls_limit) * 100 || 0,
          costUsed: data.cost_used || 0,
          costLimit: data.cost_limit || 0,
          costPercent: (data.cost_used / data.cost_limit) * 100 || 0,
          inputTokens: data.input_tokens || 0,
          outputTokens: data.output_tokens || 0
        }

        // Update alerts
        updateAlerts()
      } catch (error) {
        console.error('Failed to fetch AI usage:', error)
      }
    }

    const updateAlerts = () => {
      alerts.value = []

      if (usage.value.callsPercent >= 100) {
        alerts.value.push({
          id: 'calls-exceeded',
          severity: 'error',
          message: 'You have reached your AI call limit for this month'
        })
      } else if (usage.value.callsPercent >= 90) {
        alerts.value.push({
          id: 'calls-warning',
          severity: 'warning',
          message: 'You have used 90% of your AI calls for this month'
        })
      }

      if (usage.value.costPercent >= 100) {
        alerts.value.push({
          id: 'cost-exceeded',
          severity: 'error',
          message: 'You have reached your AI budget for this month'
        })
      } else if (usage.value.costPercent >= 80) {
        alerts.value.push({
          id: 'cost-warning',
          severity: 'warning',
          message: 'You have used 80% of your AI budget for this month'
        })
      }
    }

    const getUsageClass = (percent) => {
      if (percent >= 100) return 'danger'
      if (percent >= 80) return 'warning'
      return 'normal'
    }

    const formatNumber = (num) => {
      return new Intl.NumberFormat().format(num)
    }

    const alertIcon = (severity) => {
      const icons = {
        'error': 'fas fa-times-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
      }
      return icons[severity] || 'fas fa-info-circle'
    }

    const updateConfig = async () => {
      try {
        await fetch('/api/v1/me/ai/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(localConfig.value)
        })
        emit('config-changed', localConfig.value)
      } catch (error) {
        console.error('Failed to update config:', error)
      }
    }

    // Lifecycle
    onMounted(() => {
      fetchUsage()
      // Refresh every 5 minutes
      const interval = setInterval(fetchUsage, 5 * 60 * 1000)

      // Cleanup
      return () => clearInterval(interval)
    })

    return {
      // State
      showBreakdown,
      showConfig,
      alerts,
      usage,
      localConfig,

      // Computed
      periodDates,
      currentModel,
      modelDisplayName,
      showUpgradePrompt,
      canEditMaxCost,
      infrastructureCost,
      aiCost,
      marginCost,
      totalCost,
      forecastTotal,
      forecastWarning,

      // Methods
      fetchUsage,
      getUsageClass,
      formatNumber,
      alertIcon,
      updateConfig
    }
  }
}
</script>

<style scoped>
.ai-usage-widget {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.widget-header h3 {
  margin: 0;
  font-size: 18px;
  color: #1a1a1a;
}

.model-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.model-haiku-4\.5, .model-haiku {
  background: #e8f5e9;
  color: #2e7d32;
}

.model-sonnet-4\.5, .model-sonnet {
  background: #e3f2fd;
  color: #1565c0;
}

.model-opus-4\.5, .model-opus {
  background: #fce4ec;
  color: #c2185b;
}

.model-none {
  background: #f5f5f5;
  color: #757575;
}

.usage-section {
  margin-bottom: 20px;
}

.usage-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.period-label {
  font-weight: 600;
  color: #1a1a1a;
}

.period-dates {
  color: #666;
  font-size: 14px;
}

.usage-metrics {
  margin-bottom: 15px;
}

.metric {
  margin-bottom: 10px;
}

.metric-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 14px;
}

.metric-value {
  font-weight: 600;
}

.progress-bar {
  height: 8px;
  background: #f0f0f0;
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  transition: width 0.3s ease;
}

.progress-fill.normal {
  background: #4caf50;
}

.progress-fill.warning {
  background: #ff9800;
}

.progress-fill.danger {
  background: #f44336;
}

.token-breakdown {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 4px;
}

.token-item {
  text-align: center;
}

.token-label {
  display: block;
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

.token-value {
  font-weight: 600;
  color: #1a1a1a;
}

.cost-breakdown {
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 20px;
}

.cost-breakdown h4 {
  margin: 0 0 10px;
  font-size: 14px;
  color: #1a1a1a;
}

.breakdown-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 14px;
}

.breakdown-item.total {
  font-weight: 600;
  border-top: 1px solid #ddd;
  padding-top: 5px;
  margin-top: 5px;
}

.forecast-section {
  border-top: 1px solid #eee;
  padding-top: 15px;
}

.forecast-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.toggle-btn {
  background: none;
  border: none;
  color: #2196f3;
  cursor: pointer;
  font-size: 14px;
}

.toggle-btn:hover {
  text-decoration: underline;
}

.forecast-amount {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
}

.estimated {
  color: #666;
}

.amount {
  font-weight: 600;
  color: #1a1a1a;
}

.forecast-note {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  padding: 8px 12px;
  background: #fff3cd;
  color: #856404;
  border-radius: 4px;
  font-size: 14px;
}

.alerts {
  margin-bottom: 20px;
}

.alert {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border-radius: 4px;
  font-size: 14px;
  margin-bottom: 10px;
}

.alert.error {
  background: #ffebee;
  color: #c62828;
}

.alert.warning {
  background: #fff3cd;
  color: #856404;
}

.alert.info {
  background: #e3f2fd;
  color: #1565c0;
}

.upgrade-prompt {
  padding: 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 8px;
  text-align: center;
}

.upgrade-prompt p {
  margin: 0 0 15px;
}

.upgrade-btn {
  background: white;
  color: #667eea;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}

.upgrade-btn:hover {
  transform: translateY(-1px);
}

.config-section {
  border-top: 1px solid #eee;
  padding-top: 15px;
}

.config-btn {
  background: none;
  border: 1px solid #ddd;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  color: #666;
}

.config-btn:hover {
  background: #f5f5f5;
}

.config-panel {
  margin-top: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 4px;
}

.config-item {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.config-item:last-child {
  margin-bottom: 0;
}

.config-item label {
  min-width: 150px;
  font-size: 14px;
  color: #1a1a1a;
}

.config-item input[type="range"] {
  flex: 1;
}

.config-item select,
.config-item input[type="number"] {
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.config-item input:disabled {
  background: #f5f5f5;
  cursor: not-allowed;
}
</style>